= Time Series
// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.

This section of the user guide provides an overview of time series *aggregation*,
*smoothing* and *differencing*.

== Time Series Aggregation

The `timeseries` function performs fast, distributed time
series aggregation leveraging Solr's builtin faceting and date math capabilities.

The example below performs a monthly time series aggregation over a collection of
daily stock price data.  In this example the average monthly closing price is calculated for the stock
ticker *amzn* between a specific date range.

[source,text]
----
timeseries(stocks,
           q=ticker_s:amzn,
           field="date_dt",
           start="2010-01-01T00:00:00Z",
           end="2017-11-01T00:00:00Z",
           gap="+1MONTH",
           format="YYYY-MM",
           avg(close_d))
----

When this expression is sent to the `/stream` handler it responds with:

[source,json]
----
{
  "result-set": {
    "docs": [
      {
        "date_dt": "2010-01",
        "avg(close_d)": 127.42315789473685
      },
      {
        "date_dt": "2010-02",
        "avg(close_d)": 118.02105263157895
      },
      {
        "date_dt": "2010-03",
        "avg(close_d)": 130.89739130434782
      },
      {
        "date_dt": "2010-04",
        "avg(close_d)": 141.07
      },
      {
        "date_dt": "2010-05",
        "avg(close_d)": 127.606
      },
      {
        "date_dt": "2010-06",
        "avg(close_d)": 121.66681818181816
      },
      {
        "date_dt": "2010-07",
        "avg(close_d)": 117.5190476190476
      },
      ...
----

Using Zeppelin-Solr this time series can be visualized using a line chart or other visualization.

image::images/math-expressions/timeseries1.png[]


== Vectorizing the Time Series

Before a time series result can be operated on by math expressions
 the data will need to be vectorized. Specifically
in the example above, the aggregation field count(*) will need to by moved into an array.
As described in the Streams and Vectorization section of the user guide, the `col` function can be used
to copy a numeric column from a list of tuples into an array.

The expression below demonstrates the vectorization of the count(*) field.

image::images/math-expressions/timeseries2.png[]


== Smoothing

Time series smoothing is often used to remove the noise from a time series and help
spot the underlying trends.
The math expressions library has three *sliding window* approaches
for time series smoothing. The *sliding window* approaches use a summary value
from a sliding window of the data to calculate a new set of smoothed data points.

The three *sliding window* functions are lagging indicators, which means
they don't start to move in the direction of the trend until the trend effects
the summary value of the sliding window. Because of this lagging quality these smoothing
functions are often used to confirm the direction of the trend.

=== Moving Average

The `movingAvg` function computes a simple moving average over a sliding window of data.
The example below generates a time series, vectorizes the count(*) field and computes the
moving average with a window size of 3.

The moving average function returns an array that is of shorter length
then the original data set. This is because results are generated only when a full window of data
is available for computing the average. With a window size of three the moving average will
begin generating results at the 3rd value. The prior values are not included in the result.

This is true for all the sliding window functions.


image::images/math-expressions/movingavg.png[]

=== Exponential Moving Average

The `expMovingAvg` function uses a different formula for computing the moving average that
responds faster to changes in the underlying data. This means that it is
less of a lagging indicator then the simple moving average.

Below is an example that computes an exponential moving average:

image::images/math-expressions/expmoving.png[]


=== Moving Median

The `movingMedian` function uses the median of the sliding window rather than the average.
In many cases the moving median will be more *robust* to outliers then moving averages.

Below is an example computing the moving median:

image::images/math-expressions/movingMedian.png[]


== Differencing

Differencing can be used to make
a time series stationary by removing the trend or seasonality from data.

=== First Difference

The actual technique of differencing is to use the difference between values rather than the
original values. The *first difference* takes the difference between a value and the value
that came directly before it. The first difference is often used to remove the trend
from a time series.

The examples below use the first difference to make two time series stationary so they can be compared
without the trend.

In this example we'll be comparing the average monthly closing price for two stocks: Amazon and Google.
The image below plots both time series before differencing is applied.

image::images/math-expressions/timecompare.png[]

In the next example the `diff` function is applied to both time series inside the `zplot` function.
The `diff` can be applied inside the `zplot` function or like any other function inside of the `let`
function.

Notice that both time series now have the trend removed and the monthly movements of the stock price
can be studied without being influenced by the trend.

image::images/math-expressions/diff1.png[]

In the next example the `zoom` function of the time series visualization is used to zoom into a specific
range of months. This allows for closer inspection of the data. With closer inspection of the data there appears
to be some correlation between the monthly movements of the two stocks.

image::images/math-expressions/diffzoom.png[]

In the final example the differenced time series are correlated with the `corr` function.

image::images/math-expressions/diffcorr.png[]



=== Lagged Differences

The `diff` function has an optional second parameter to specify a lag in the difference.
If a lag is specified the difference is taken between a value and the value at a specified
lag in the past. Lagged differences are often used to remove seasonality from a time series.

The simple example below demonstrates how lagged differencing works.
Notice that the array in the example follows a simple repeated pattern. This type of pattern
is often displayed with seasonality. In this example we can remove this pattern using
the `diff` function with a lag of 4. This will subtract the value lagging four indexes
behind the current index. Notice that result set size is the original array size minus the lag.
This is because the `diff` function only returns results for values where the lag of 4
is possible to compute.

image::images/math-expressions/season.png[]

image::images/math-expressions/seasondiff.png[]


== Anomaly Detection

The `movingMAD` (moving mean absolute deviation) function can be used to surface anomalies
in a time series by measuring dispersion (deviation from the mean) within a sliding window.

The `movingMAD` function operates in a similar manner as a moving average, except it
measures the mean absolute deviation within the window rather then the average. By
looking for unusually high or low dispersion we can find anomalies in the time
series.

For this example we'll be working with daily stock prices for Amazon over a two year
period. The daily stock data will provide a larger data set to study.

In the example below the `search` expression is used to return the daily closing price
for the ticker *amzn* over a two year period.

image::images/math-expressions/anomaly.png[]

The next step is to apply the `movingMAD` function to the data to calculate
the moving mean absolute deviation over a 10 day window. The example below shows the function being
applied and visualized.

image::images/math-expressions/mad.png[]

Once the moving MAD has been calculated we can visualize the distribution of dispersion
with the `empiricalDistribution` function. The example below plots the empirical
distribution with 10 bins, creating a 10 bin histogram of the dispersion of the
time series.

This visualization shows that most of the mean absolute deviations fall between 0 and
9.2 with the mean of the final bin at 11.94.

image::images/math-expressions/maddist.png[]

The final step is to detect outliers in the data set using the `outliers` function.
The `outliers` function takes four parameters:

* Probability distribution
* Numeric vector
* Low probability threshold
* High probablity threshold
* List of results that the vector of numbers was selected from.

The `outliers` function iterates the numeric vector and uses the probability
distribution to calculate the cumulative probability of each value. If the cumulative
value is below the low probability threshold or above the high threshold it considers
the value an outlier. When the `outliers` function encounters an outlier it returns
the corresponding result from the list of results provided as the fifth parameter.
It also includes the cumulative probability and the value of the outlier.

The example below shows the `outliers` function applied to the Amazon stock
price data set. The empirical distribution of the moving mean absolute deviation is
the first parameter. The vector containing the moving mean absolute
deviations is the second parameter. -1 is the low and .99 is the high probability
thresholds. -1 means that low outliers will not be considered. The final parameter
is the original result set containing the *close_d* and *date_dt* fields.

The output of the `outliers` function contains the results where an outlier was detected.
In this case 5 results above the .99 probability threshold were detected.


image::images/math-expressions/outliers.png[]


== Modeling

image::images/math-expressions/timemodel.png[]



== Forecasting

image::images/math-expressions/forecast.png[]
