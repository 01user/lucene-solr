/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// This should be eventually rewritten in plain gradle. For now, delegate to
// the ant/groovy script we already have.

configure(rootProject) {
  task("validateSourcePatterns", type: ValidateSourcePatternsTask) {
    group = 'Verification'
    description = 'Validate Source Patterns'
    
    sourceFiles = project.fileTree(project.rootDir) {
      [
        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',
        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',
        'properties', 'mdtext', 'groovy', 'gradle',
        'template', 'adoc', 'json',
      ].each{
        include "lucene/**/*.${it}"
        include "solr/**/*.${it}"
        include "dev-tools/**/*.${it}"
        include "gradle/**/*.${it}"
        include "*.${it}"
      }
      // TODO: For now we don't scan txt / md files, so we
      // check licenses in top-level folders separately:
      include '*.txt'
      include '*/*.txt'
      include '*.md'
      include '*/*.md'
      // excludes:
      exclude '**/build/**'
      exclude '**/dist/**'
      exclude 'dev-tools/missing-doclet/src/**/*.java' // <-- TODO: remove once we allow "var" on master
      exclude 'lucene/benchmark/work/**'
      exclude 'lucene/benchmark/temp/**'
      exclude '**/CheckLoggingConfiguration.java'
      exclude 'solr/core/src/test/org/apache/hadoop/**'
      exclude '**/validate-source-patterns.gradle' // ourselves :-)
    }
  }

  dependencies {
    checkSourceDeps "org.codehaus.groovy:groovy-all:2.4.17"
    checkSourceDeps "org.apache.rat:apache-rat:${scriptDepVersions['apache-rat']}"
  }

  task validateSourcePatterns() {
    doFirst {
      ant.taskdef(
          name: "groovy",
          classname: "org.codehaus.groovy.ant.Groovy",
          classpath: configurations.checkSourceDeps.asPath)

      ant.groovy(src: rootProject.file("gradle/validation/validate-source-patterns/check-source-patterns.groovy"))
    }
  }
}
